<div x-data="{ isRTL: document.dir === 'rtl' }" :dir="isRTL ? 'rtl' : 'ltr'">
    <div class="h-full flex flex-col"
         x-data="pageEditor({
           bundle: '{{ bundle }}',
           bundle_label: '{{ bundle_label }}',
           language: '{{ language }}',
           fields: '{{ fields|json_encode|e('js') }}',
           nid: '{{ nid }}',
           node: '{{ node|json_encode|e('js') }}',
           has_translation: '{{ has_translation }}',
           changed: '{{ changed }}',
           status: '{{ status }}'
         })">
        <div class="sticky top-0 z-10 bg-white">
            {# Header with back button, title and actions #}
            <div class="bg-white py-4 px-3 border-b border-slate-200 flex justify-between items-center gap-x-4 md:[dir='rtl']:flex-row-reverse">
                <div class="flex items-center gap-x-3 md:[dir='rtl']:flex-row-reverse">
                    <a href="{{ path('vactory_dashboard.content_types', {'bundle': bundle}) }}"
                       class="me-3 text-slate-500 hover:text-primary-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-4 w-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
                        </svg>
                    </a>
                    <h1 class="flex items-center text-lg font-medium">{{ "Edit"|t }} {{ bundle_label }}&nbsp;-&nbsp;<span class="inline-block capitalize max-w-60 truncate">{{ node.title }}</span></h1>
                </div>
                <div class="flex max-lg:w-full max-lg:flex-wrap max-lg:gap-3 max-lg:[&>*]:w-full max-lg:fixed max-lg:bottom-0 max-lg:left-0 max-lg:bg-white max-lg:shadow-lg max-lg:border-t max-lg:border-slate-200 max-lg:px-3 max-lg:py-4 lg:items-center lg:space-x-4">
                    {# Publish checkbox #}
                    <div class="flex items-center">
                        <input
                                type="checkbox"
                                id="publish-status"
                                x-model="formData.status"
                                class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-slate-300 rounded">
                        <label for="publish-status" class="ms-2 block text-sm text-slate-700">
                            {{ 'Publish'|t }}
                        </label>
                    </div>
                    {% include "@vactory_dashboard/node/_components/langs.html.twig" %}

                    {% if alias %}
                        {% include "@vactory_dashboard/node/_components/preview.html.twig" with { preview_url: alias } %}
                    {% endif %}

                    <button
                            @click="saveNode()"
                            :disabled="isSaving"
                            :class="{
                    'opacity-50 cursor-not-allowed': isSaving,
                    'bg-primary-500 hover:bg-primary-600': !isSaving,
                    'bg-primary-400': isSaving
                }"
                            class="inline-flex items-center justify-center gap-x-2 rounded-lg transition-all duration-150 px-5 py-2 text-sm font-semibold text-white bg-primary-500 hover:bg-primary-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
                    >
                        <!-- Loading spinner (shown when saving) -->
                        <svg x-show="isSaving" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                             fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor"
                                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <!-- Button text (changes based on loading state) -->
                        <span x-text="isSaving ? '{{ 'Saving...'|t }}' : '{{ 'Save'|t }}'"></span>
                    </button>
                </div>
            </div>
            {% include "@vactory_dashboard/node/content-types/_components/tabs.html.twig" %}
            {# Notification #}
            {% include "@vactory_dashboard/node/_components/message-notification.html.twig" %}
        </div>
        {# Form Fields #}
        <div class="flex-1">
            <div class="mx-auto">
                <form id="node-form" @submit.prevent="saveNode()"
                      class="bg-white rounded-lg shadow-sm p-2 space-y-6">
                    <div x-show="activeTab === 'content'" class="flex gap-y-6 flex-col">
                        <template x-for="(field, fieldName) in contentFields" :key="field.name">
                            {% include "@vactory_dashboard/_components/fields/form-field-builder.html.twig" with {
                                field: 'field',
                                formData: 'formData',
                                isEdit: true,
                                language: language,
                                node_default_lang: node_default_lang
                            } %}
                        </template>
                    </div>
                    <div x-show="activeTab === 'cross_content'">
                        <template x-for="(field, fieldName) in crossContentFields" :key="field.name">
                            {% include "@vactory_dashboard/_components/fields/cross-content-field-builder.html.twig" with {
                                field: 'field',
                                isEdit: true,
                                language: language,
                                node_default_lang: node_default_lang
                            } %}
                        </template>
                    </div>

                    {% if has_paragraphs_field %}
                        <div x-show="activeTab === 'templates'">
                            <div x-show="!showBlockForm && !showParagraphBlockForm && !showParagraphViewForm">
                                {% include "@vactory_dashboard/node/_components/add-block-action.html.twig" with {
                                    show: node_default_lang == language
                                } %}
                            </div>

                            {# Block Form View #}
                            <template x-if="showBlockForm" class="h-full">
                                <div>
                                    {% include "@vactory_dashboard/_components/paragraph/paragraph-template-form.html.twig" %}
                                </div>
                            </template>

                            {# Paragraph Block Form View #}
                            <template x-if="showParagraphBlockForm" class="h-full">
                                {% include "@vactory_dashboard/_components/paragraph/paragraph-block-form.html.twig" %}
                            </template>

                            {# Paragraph View Form View #}
                            <template x-if="showParagraphViewForm" class="h-full">
                                {% include "@vactory_dashboard/_components/paragraph/paragraph-view-form.html.twig" %}
                            </template>

                            <div x-show="!showBlockForm && !showParagraphBlockForm" class="space-y-1">
                                {% include "@vactory_dashboard/_components/paragraph/blocks.html.twig" %}
                            </div>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
        {% include "@vactory_dashboard/_components/media/media-library.html.twig" %}
        {# SEO Tab #}
        {% include "@vactory_dashboard/node/_components/seo-form.html.twig" %}

        {# Include the blocks modal #}
        {% include "@vactory_dashboard/_components/paragraph/blocks-modal.html.twig" %}

        {# Dynamic Field Modal - Single modal for all WYSIWYG dynamic fields #}
        <div x-show="showDynamicFieldModal" 
             class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
            
            <div class="bg-white rounded-xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95">
                
                {# Modal Header #}
                <div class="flex items-center justify-between p-6 border-b border-slate-200">
                    <h2 class="text-lg font-semibold text-slate-900">
                        {{ 'Add Paragraph Template'|t }} 
                    </h2>
                    <button @click="showDynamicFieldModal = false; selectedDynamicField = null" 
                            type="button"
                            class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                {# Modal Content #}
                <div class="overflow-y-auto max-h-[calc(90vh-120px)]">
                    {% include "@vactory_dashboard/_components/paragraph/paragraph-template-form.html.twig" with {
                        hideBlockConfig: true,
                    } %}
                </div>
            </div>
        </div>
    </div>
</div>