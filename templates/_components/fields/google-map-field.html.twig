{# /** * @file * Google Map field template for Vactory Dashboard. * * Available
variables: * - field: The field definition and data (Alpine.js variable). */ #}

<div
  class="grid grid-cols-1 md:grid-cols-2 gap-4"
  x-data="{
        fieldName: field.name,
        showMapModal: false,
        previewMap: null,
        previewMarker: null,
        modalMap: null,
        modalMarker: null,
        geocoder: null,
        tempLat: null,
        tempLng: null,
        tempZoom: null,
        tempType: null,
        searchAddress: '',

        init() {
            // Ensure formData.fields[fieldName] exists with all required properties
            if (!formData.fields[this.fieldName]) {
                formData.fields[this.fieldName] = {};
            }
            if (formData.fields[this.fieldName].lat === undefined) {
                formData.fields[this.fieldName].lat = '';
            }
            if (formData.fields[this.fieldName].lng === undefined) {
                formData.fields[this.fieldName].lng = '';
            }
            if (formData.fields[this.fieldName].zoom === undefined) {
                formData.fields[this.fieldName].zoom = 10;
            }
            if (formData.fields[this.fieldName].type === undefined) {
                formData.fields[this.fieldName].type = 'roadmap';
            }
            if (formData.fields[this.fieldName].address === undefined) {
                formData.fields[this.fieldName].address = '';
            }

            this.initPreviewMap();
        },

        initPreviewMap() {
            const self = this;
            this.$nextTick(() => {
                const mapElement = document.getElementById('google-map-preview-' + self.fieldName);
                if (!mapElement || typeof google === 'undefined') {
                    console.warn('Preview map element not found or Google Maps not loaded');
                    return;
                }

                const lat = parseFloat(formData.fields[self.fieldName].lat) || 33.5731;
                const lng = parseFloat(formData.fields[self.fieldName].lng) || -7.5898;
                const zoom = parseInt(formData.fields[self.fieldName].zoom) || 10;

                self.previewMap = new google.maps.Map(mapElement, {
                    center: { lat, lng },
                    zoom: zoom,
                    disableDefaultUI: true,
                    zoomControl: true,
                });

                const existingLat = parseFloat(formData.fields[self.fieldName].lat);
                const existingLng = parseFloat(formData.fields[self.fieldName].lng);

                if (!isNaN(existingLat) && !isNaN(existingLng) && existingLat !== 0 && existingLng !== 0) {
                    self.previewMarker = new google.maps.Marker({
                        map: self.previewMap,
                        position: { lat: existingLat, lng: existingLng },
                    });
                }
            });
        },

        openModal() {
            const self = this;

            // Store current values for cancel
            this.tempLat = formData.fields[this.fieldName].lat;
            this.tempLng = formData.fields[this.fieldName].lng;
            this.tempZoom = formData.fields[this.fieldName].zoom;
            this.tempType = formData.fields[this.fieldName].type;
            this.searchAddress = formData.fields[this.fieldName].address || '';

            // Clean up existing modal map
            if (this.modalMarker) {
                this.modalMarker.setMap(null);
                this.modalMarker = null;
            }
            if (this.modalMap && typeof google !== 'undefined') {
                google.maps.event.clearInstanceListeners(this.modalMap);
                this.modalMap = null;
            }

            this.showMapModal = true;
            
            setTimeout(() => {
                const mapElement = document.getElementById('google-map-modal-' + self.fieldName);
                if (!mapElement) {
                    console.error('Modal map element not found');
                    return;
                }
                
                if (typeof google === 'undefined') {
                    console.error('Google Maps API not loaded');
                    alert('Google Maps API not loaded. Please refresh the page.');
                    return;
                }
                
                const lat = parseFloat(formData.fields[self.fieldName].lat) || 33.5731;
                const lng = parseFloat(formData.fields[self.fieldName].lng) || -7.5898;
                const zoom = parseInt(formData.fields[self.fieldName].zoom) || 10;
                const mapType = formData.fields[self.fieldName].type || 'roadmap';
                
                self.modalMap = new google.maps.Map(mapElement, {
                    center: { lat, lng },
                    zoom: zoom,
                    mapTypeId: mapType,
                    streetViewControl: false,
                });
                
                self.geocoder = new google.maps.Geocoder();
                
                // Sync zoom changes
                self.modalMap.addListener('zoom_changed', () => {
                    formData.fields[self.fieldName].zoom = self.modalMap.getZoom();
                });
                
                // Create marker if coordinates exist
                const existingLat = parseFloat(formData.fields[self.fieldName].lat);
                const existingLng = parseFloat(formData.fields[self.fieldName].lng);
                
                if (!isNaN(existingLat) && !isNaN(existingLng) && (existingLat !== 0 || existingLng !== 0)) {
                    self.createMarker(existingLat, existingLng);
                }
                
                // Click to place marker
                self.modalMap.addListener('click', (event) => {
                    const clickLat = event.latLng.lat();
                    const clickLng = event.latLng.lng();
                    self.createMarker(clickLat, clickLng);
                    self.modalMap.panTo(event.latLng);
                });
            }, 300);
        },
        
        createMarker(lat, lng) {
            const self = this;
            
            // If marker already exists, just update its position
            if (this.modalMarker) {
                this.modalMarker.setPosition({ lat, lng });
            } else {
                // Create new marker only if it doesn't exist
                this.modalMarker = new google.maps.Marker({
                    map: this.modalMap,
                    draggable: true,
                    position: { lat, lng },
                });
                
                // Add drag listener (only needs to be added once)
                this.modalMarker.addListener('dragend', () => {
                    const position = self.modalMarker.getPosition();
                    self.modalMap.panTo(position);
                });
            }
        },
        
        searchLocation() {
            const self = this;
            const address = this.searchAddress;
            
            if (!address || address.trim() === '') {
                alert('Please enter an address to search');
                return;
            }
            
            if (!this.geocoder) {
                alert('Geocoder not initialized. Please try reopening the map.');
                return;
            }
            
            if (!this.modalMap) {
                alert('Map not initialized. Please try reopening the map.');
                return;
            }
            
            this.geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const lat = results[0].geometry.location.lat();
                    const lng = results[0].geometry.location.lng();
                    
                    self.modalMap.panTo({ lat, lng });
                    self.modalMap.setZoom(15);
                    self.createMarker(lat, lng);
                } else {
                    alert('Location not found: ' + status);
                }
            });
        },
        
        insertMap() {
            const self = this;
            
            if (!this.modalMarker) {
                alert('Please place a marker on the map first by clicking on the map or searching for a location.');
                return;
            }
            
            const position = this.modalMarker.getPosition();
            const lat = position.lat();
            const lng = position.lng();
            const zoom = this.modalMap.getZoom();
            
            console.log('Inserting map with coordinates:', lat, lng, zoom);
            
            // Update form data - use direct assignment
            formData.fields[this.fieldName].lat = lat;
            formData.fields[this.fieldName].lng = lng;
            formData.fields[this.fieldName].zoom = zoom;
            formData.fields[this.fieldName].address = this.searchAddress;
            
            console.log('Form data after update:', JSON.stringify(formData.fields[this.fieldName]));
            
            this.showMapModal = false;
            
            // Update preview map
            this.$nextTick(() => {
                self.updatePreviewMap(lat, lng);
            });
        },
        
        updatePreviewMap(lat, lng) {
            const self = this;
            if (!isNaN(lat) && !isNaN(lng) && self.previewMap) {
                const position = { lat: parseFloat(lat), lng: parseFloat(lng) };
                self.previewMap.setCenter(position);
                
                if (self.previewMarker) {
                    self.previewMarker.setPosition(position);
                } else {
                    self.previewMarker = new google.maps.Marker({
                        map: self.previewMap,
                        position: position,
                    });
                }
            }
        },
        
        cancelModal() {
            // Restore original values
            formData.fields[this.fieldName].lat = this.tempLat;
            formData.fields[this.fieldName].lng = this.tempLng;
            formData.fields[this.fieldName].zoom = this.tempZoom;
            formData.fields[this.fieldName].type = this.tempType;
            this.showMapModal = false;
        },
        
        clearMap() {
            formData.fields[this.fieldName].lat = '';
            formData.fields[this.fieldName].lng = '';
            formData.fields[this.fieldName].address = '';
            formData.fields[this.fieldName].zoom = 10;
            
            if (this.previewMarker) {
                this.previewMarker.setMap(null);
                this.previewMarker = null;
            }
        }
     }"
  x-init="init()"
>
  {# Left Column: Inputs and Buttons #}
  <div class="space-y-4">
    <div>
      <p class="text-sm text-gray-600 mb-4">
        {{ "Use the 'Set Map' button for more options." | t }}
      </p>
    </div>

    {# Latitude Input #}
    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">{{
        "Latitude" | t
      }}</label>
      <input
        type="text"
        x-model="formData.fields[fieldName].lat"
        :required="field.required"
        placeholder="51.524295"
        class="w-full py-1.5 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent"
      />
    </div>

    {# Longitude Input #}
    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">{{
        "Longitude" | t
      }}</label>
      <input
        type="text"
        x-model="formData.fields[fieldName].lng"
        :required="field.required"
        placeholder="-0.12799"
        class="w-full py-1.5 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent"
      />
    </div>

    {# Buttons #}
    <div class="grid grid-cols-2 gap-2">
      <button
        type="button"
        @click.prevent="openModal()"
        class="inline-flex items-center justify-center rounded-md transition-colors gap-x-2 bg-primary-500 text-white hover:bg-primary-600 px-4 py-2 text-sm"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="h-4 w-4"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"
          />
        </svg>
        <span>{{ "Set Map" | t }}</span>
      </button>
      <button
        type="button"
        @click.prevent="clearMap()"
        class="inline-flex items-center justify-center rounded-md transition-colors gap-x-2 bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 text-sm"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="h-4 w-4"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
        <span>{{ "Clear" | t }}</span>
      </button>
    </div>
  </div>

  {# Right Column: Preview Map #}
  <div>
    <h3 class="text-base font-medium text-slate-900 mb-2">
      {{ "Aper√ßu" | t }}
    </h3>
    <div class="border border-gray-300 rounded-md overflow-hidden">
      <div
        :id="'google-map-preview-' + fieldName"
        class="w-full h-64 bg-gray-100"
      ></div>
    </div>
  </div>

  {# Map Modal #}
  <div
    x-show="showMapModal"
    x-cloak
    class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
  >
    <div
      class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"
      @click.away="showMapModal = false"
    >
      {# Modal Header #}
      <div
        class="flex items-center justify-between p-6 border-b border-slate-200"
      >
        <h2 class="text-xl font-semibold text-slate-900">
          {{ "Set Map Location" | t }}
        </h2>
        <button
          type="button"
          @click.prevent="showMapModal = false"
          class="text-slate-400 hover:text-slate-600 transition-colors"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      {# Modal Body #}
      <div class="flex-1 overflow-y-auto p-6 space-y-4">
        {# Instructions #}
        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
          <p class="text-sm text-blue-800">
            {{
              "Click anywhere on the map to place a marker, or search for a location. You can drag the marker to adjust the position."
                | t
            }}
          </p>
        </div>

        {# Address Search #}
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">{{
            "Search location:" | t
          }}</label>
          <div class="flex gap-2">
            <input
              type="text"
              x-model="searchAddress"
              @keyup.enter.prevent="searchLocation()"
              placeholder="{{ 'Enter address, city, or place name' | t }}"
              class="flex-1 py-2 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent"
            />
            <button
              type="button"
              @click.prevent="searchLocation()"
              class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 flex items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              {{ "Find" | t }}
            </button>
          </div>
        </div>

        {# Map Container #}
        <div class="border border-gray-300 rounded-md overflow-hidden">
          <div
            :id="'google-map-modal-' + fieldName"
            class="w-full bg-gray-100"
            style="height: 400px; min-height: 400px"
          ></div>
        </div>

        {# Map Options #}
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">{{
              "Map Zoom" | t
            }}</label>
            <select
              x-model.number="formData.fields[fieldName].zoom"
              @change="modalMap && modalMap.setZoom(parseInt(formData.fields[fieldName].zoom))"
              class="w-full py-1.5 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent"
            >
              <template
                x-for="z in [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]"
                :key="z"
              >
                <option
                  :value="z"
                  x-text="z === 1 ? '1 (Min)' : (z === 9 ? '9 (Default)' : (z === 20 ? '20 (Max)' : z))"
                ></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">{{
              "Map Type" | t
            }}</label>
            <select
              x-model="formData.fields[fieldName].type"
              @change="modalMap && modalMap.setMapTypeId(formData.fields[fieldName].type)"
              class="w-full py-1.5 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent"
            >
              <option value="roadmap">{{ "Map" | t }}</option>
              <option value="satellite">{{ "Satellite" | t }}</option>
              <option value="hybrid">{{ "Hybrid" | t }}</option>
              <option value="terrain">{{ "Terrain" | t }}</option>
            </select>
          </div>
        </div>
      </div>

      {# Modal Footer #}
      <div
        class="flex justify-end items-center gap-3 px-6 py-4 border-t border-slate-200 bg-slate-50"
      >
        <button
          type="button"
          @click.prevent="cancelModal()"
          class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors"
        >
          {{ "Cancel" | t }}
        </button>
        <button
          type="button"
          @click.prevent="insertMap()"
          class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
        >
          {{ "Insert map" | t }}
        </button>
      </div>
    </div>
  </div>
</div>
