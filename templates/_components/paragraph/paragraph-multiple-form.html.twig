{# Paragraph view Form #}
<div x-data="{ 
    isRTL: document.dir === 'rtl',
    fieldName: 'paragraph_background_image',
    dragStartWidgetIndex: 0,
    dragStartOngletsIndex: 0,

    addParagraphMultipleItem() {
        const newItem = {
            title: '',
            tab_id: '',
            isNew: true,
            paragraph_id: '',
            widgets: []
        };
        
        this.paragraphMultipleForm.items.push(newItem);
    },

    removeParagraphMultipleItem(index) {
        this.paragraphMultipleForm.items.splice(index, 1);
    },

    dragStartOnglets(event) {
        this.dragStartOngletsIndex = parseInt(event.target.dataset.index);
        event.dataTransfer.effectAllowed = 'move';
    },

    dragEndOnglets(event) {
        const dragEndIndex = parseInt(event.target.closest('[draggable]').dataset.index);

        if (this.dragStartOngletsIndex !== null && dragEndIndex !== null && this.dragStartOngletsIndex !== dragEndIndex) {
            // Remove the dragged item
            const [draggedItem] = this.paragraphMultipleForm.items.splice(this.dragStartOngletsIndex, 1);
            // Insert it at the new position
            this.paragraphMultipleForm.items.splice(dragEndIndex, 0, draggedItem);

            // Reset drag state
            this.dragStartOngletsIndex = null;

            // Show success notification
            this.showNotification('success', '{{ 'Block order updated'|t }}');
        }
    },
    
    dragStartWidget(event) {
        this.dragStartWidgetIndex = parseInt(event.target.dataset.index);
        event.dataTransfer.effectAllowed = 'move';
    },

    dragEndWidget(event) {
        const dragOngletsIndex = parseInt(event.target.closest('[draggable]').dataset.onglets);
        const dragEndIndex = parseInt(event.target.closest('[draggable]').dataset.widget);

        if (this.dragStartWidgetIndex !== null && dragEndIndex !== null && this.dragStartWidgetIndex !== dragEndIndex) {
            // Remove the dragged item
            const [draggedItem] = this.paragraphMultipleForm.items[dragOngletsIndex].widgets.splice(this.dragStartWidgetIndex, 1);
            // Insert it at the new position
            this.paragraphMultipleForm.items[dragOngletsIndex].widgets.splice(dragEndIndex, 0, draggedItem);

            // Reset drag state
            this.dragStartWidgetIndex = null;

            // Show success notification
            this.showNotification('success', '{{ 'Item order updated'|t }}');
        }
    },
}"
:dir="isRTL ? 'rtl' : 'ltr'">
{% include "@vactory_dashboard/_components/media/media-library.html.twig" with {'paragraph': 'paragraphMultipleForm'} %}
{% include '@vactory_dashboard/_components/modals/delete-confirmation-modal.html.twig' with {
    'show_var': 'showDeleteModalMultiple',
    'confirm_action': 'removeTemplateMultiple()',
    'title': 'Delete Template'|t,
    'message': 'Are you sure you want to delete this template? This action cannot be undone.'|t,
    'confirm_text': 'Delete Template'|t
} %}
    <div class="h-full flex flex-col bg-slate-50">
        <div class="sticky top-0 z-10 bg-white rounded-xl py-4 px-6 border-b border-slate-200 flex justify-between items-center mb-6">
            <div class="flex items-center gap-x-3">
                <button @click="showParagraphMultipleForm = false; paragraphMultipleForm = { viewType: '', content: '', config: { title: '', show_title: false, width: 'full_width', spacing: '_none', css_classes: '' } }" type="button"
                        class="me-3 text-slate-400 hover:text-primary-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                         stroke="currentColor" class="h-4 w-4">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
                    </svg>
                </button>
                <h1 class="text-lg font-semibold text-slate-900">{{ 'Add Multiple'|t }}</h1>
            </div>
            <div class="max-lg:fixed max-lg:w-full max-lg:bottom-0 max-lg:left-0 max-lg:bg-white max-lg:shadow-lg max-lg:border-t max-lg:border-slate-200 max-lg:p-3 max-lg:[&>*]:w-full max-lg:z-[1] flex items-center gap-x-2">
                {% include '@vactory_admin/components/button/button.twig' with {
                    'variant': 'secondary',
                    'size': 'md',
                    'type': 'button',
                    'text': 'Annuler'|t,
                    'attributes': create_attribute().setAttribute('@click', 'showTemplatesList = false; isParagraphMultiple = false; showParagraphMultipleForm = false; currentBlockIndex = null; paragraphMultipleForm = { viewType: \'\', content: \'\', items: [], config: { title: \'\', show_title: false, width: \'full_width\', spacing: \'_none\', css_classes: \'\' } }')
                } %}
                {% include '@vactory_admin/components/button/button.twig' with {
                    'variant': 'primary',
                    'size': 'md',
                    'type': 'button',
                    'text': 'Enregistrer'|t,
                    'attributes': create_attribute().setAttribute('@click', 'saveParagraphMultiple()')
                } %}
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <div class="mx-auto">
                <form id="paragraph-multiple-form" @submit.prevent="saveParagraphMultiple()" class="bg-white rounded-xl shadow-sm p-2 lg:p-8">
                    <div class="flex items-start flex-col md:flex-row gap-6">
                        <div class="w-full md:w-2/3">
                            {# Main Form Section #}
                            <div class="mb-8 border-b border-slate-200 p-6 rounded-xl bg-slate-50">
                                <h3 class="text-base font-semibold text-slate-900 mb-4">{{ 'Multiple Content'|t }}</h3>
                                <div class="space-y-4">

                                    {# Spacing - select #}
                                    <div>
                                        <label class="multiple text-sm font-medium text-slate-700 mb-1 required">
                                            {{ 'Spacing'|t }}
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <select x-model="paragraphMultipleForm.spacing"
                                                required
                                                class="w-full py-2 px-3 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent transition-all duration-150">
                                            <option value="">{{ 'Select spacing'|t }}</option>
                                            <option value="small_space">Small Space</option>
                                            <option value="big_space">Big Space</option>
                                            <option value="no_space">No Spacing</option>
                                        </select>
                                    </div>

                                    {# Display - radio #}
                                    <div>
                                        <label class="view text-sm font-medium text-slate-700 mb-1 required">
                                            {{ 'Display'|t }}
                                            <span class="text-red-500">*</span>
                                        </label>

                                        <div>
                                            <label>
                                                <input required x-model="paragraphMultipleForm.display" type="radio" value="none">
                                                None
                                            </label>
                                        </div>

                                        <div>
                                            <label>
                                                <input x-model="paragraphMultipleForm.display" type="radio" value="tab">
                                                Tab display
                                            </label>
                                        </div>

                                        <div>
                                            <label>
                                                <input x-model="paragraphMultipleForm.display" type="radio" value="accordion">
                                                Accordion display
                                            </label>
                                        </div>
                                    </div>

                                    {# title - input #}
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1 required">
                                            {{ 'Title'|t }}
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text"
                                           x-model="paragraphMultipleForm.title"
                                           required
                                           @invalid="$el.classList.add('border-red-500')"
                                           @input="$el.classList.remove('border-red-500')"
                                           class="w-full py-2 px-3 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent transition-all duration-150">
                                    </div>

                                    {# intro - textarea #}
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1 required">
                                            {{ 'Introduction'|t }}
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <textarea x-model="paragraphMultipleForm.introduction"
                                                  required
                                                  rows="6"
                                                  class="w-full py-2 px-3 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent transition-all duration-150"
                                                  placeholder="{{ 'Enter your content here...'|t }}"></textarea>
                                    </div>
                                </div>
                            </div>

                            {# Onglets #}
                                <div x-data="{ collapsedView: false }">
                                        <div>
                                            <div>
                                                <div id="onglets" class="flex justify-between items-center mb-6">
                                                    <span class="flex items-center text-sm font-medium text-slate-700">
                                                        Onglets
                                                        <span class="ml-1 flex justify-end text-xs font-medium text-primary-400">
                                                            (
                                                                <span class="inline-block mr-1"
                                                                      x-text="paragraphMultipleForm.items.length"></span>
                                                                <span x-show="paragraphMultipleForm.items.length == 1"
                                                                      class="inline-block">élément disponible</span>
                                                                <span x-show="paragraphMultipleForm.items.length > 1"
                                                                      class="inline-block">éléments disponibles</span>
                                                            )
                                                        </span>
                                                    </span>
                                                    {% include '@vactory_admin/components/button/button.twig' with {
                                                        'variant': 'secondary',
                                                        'size': 'sm',
                                                        'text': 'Toggle onglets'|t,
                                                        'attributes': create_attribute()
                                                            .setAttribute('@click', 'collapsedView = !collapsedView')
                                                            .setAttribute('type', 'button')
                                                    } %}
                                                </div>
                                            </div>
                                            <div class="space-y-4">
                                                <template x-for="(item, index) in paragraphMultipleForm.items" :key="index">
                                                    <div :class="item._isNewItem ? 'bg-slate-200' : 'bg-slate-50'"
                                                         class="p-4 rounded-xl relative transition-colors duration-300"
                                                         draggable="true"
                                                         :data-index="index" :data-item-index="index"
                                                         @dragstart="dragStartOnglets($event)"
                                                         @dragover.prevent="$event.target.closest('[draggable]').classList.add('bg-slate-100')"
                                                         @dragleave.prevent="$event.target.closest('[draggable]').classList.remove('bg-slate-100')"
                                                         @drop.prevent="dragEndOnglets($event)"
                                                         @dragend="$event.target.closest('[draggable]').classList.remove('bg-slate-100')">
                                                        <div class="absolute top-2 end-2 flex items-center gap-x-2">
                                                            <button type="button"
                                                                    class="cursor-move text-slate-400 hover:text-primary-500">
                                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                                                                     fill="none" viewbox="0 0 24 24"
                                                                     stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                          stroke-width="2" d="M4 8h16M4 16h16"></path>
                                                                </svg>
                                                            </button>
                                                            <button type="button" x-show="paragraphMultipleForm.items.length > 1"
                                                                    @click="removeParagraphMultipleItem(index)"
                                                                    class="text-slate-400 hover:text-red-500">
                                                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg"
                                                                     fill="none" viewbox="0 0 24 24"
                                                                     stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                          stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <div class="space-y-4 mt-6">
                                                            {# START - multiple #}
                                                                <div>
                                                                    <label class="block text-sm font-medium text-slate-700 mb-1">
                                                                        Titre
                                                                        <span class="text-red-500">*</span>
                                                                    </label>

                                                                    {# Text Input #}
                                                                    <input type="text"
                                                                            x-model="item.title"
                                                                            required
                                                                            class="w-full py-2 px-3 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent bg-white transition-all duration-150">

                                                                </div>

                                                                <div>
                                                                    <label class="block text-sm font-medium text-slate-700 mb-1">
                                                                        {{ 'Tab ID'|t }}
                                                                    </label>

                                                                    {# Tab ID Input #}
                                                                    <input type="text"
                                                                            x-model="item.tab_id"
                                                                            placeholder="{{ 'Enter unique tab identifier...'|t }}"
                                                                            class="w-full py-2 px-3 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-transparent bg-white transition-all duration-150">
                                                                </div>

                                                                {# Widgets #}
                                                                <template x-for="(widget, widgetIndex) in item.widgets || []">
                                                                    <div
                                                                            class="bg-white rounded-lg shadow-sm"
                                                                            draggable="true"
                                                                            :data-widget="widgetIndex" :data-item-index="widgetIndex"
                                                                            :data-onglets="index"
                                                                            @dragstart="dragStartWidget($event)"
                                                                            @dragover.prevent="$event.target.closest('[draggable]').classList.add('bg-gray-50')"
                                                                            @dragleave.prevent="$event.target.closest('[draggable]').classList.remove('bg-gray-50')"
                                                                            @drop.prevent="dragEndWidget($event)"
                                                                            @dragend="$event.target.closest('[draggable]').classList.remove('bg-gray-50')">
                                                                        <div class="bg-white rounded-lg shadow-sm">
                                                                            <div class="p-3 flex items-center justify-between">
                                                                                <div class="flex items-center gap-3 w-full">

                                                                                    <div class="cursor-pointer relative overflow-hidden rounded border border-gray-200 shrink-0"
                                                                                        @click="$dispatch('open-image-modal', { src: widget.widget_config.screenshot, alt: 'Preview of ' + widget.widget_config.name })">
                                                                                        <img :alt="'Preview of ' + widget.widget_config.name" class="!w-16 h-16 object-cover"
                                                                                            :src="widget.widget_config.screenshot">
                                                                                    </div>

                                                                                    <div class="flex flex-col gap-1 items-start">
                                                                                        <span class="text-base font-medium" x-text="widget.widget_config.name"></span>
                                                                                        {# Type Badge #}
                                                                                        <span class="bg-primary-100 text-primary-800 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium">
                                                                                        Component
                                                                                        </span>
                                                                                    </div>

                                                                                </div>
                                                                                <div class="flex items-center space-x-2">
                                                                                    <div class="flex items-center space-x-2">
                                                                                        <button
                                                                                                type="button"
                                                                                                @click="copyTemplateInParagraphMutipleItem(index, widgetIndex)"
                                                                                                class="text-gray-400 hover:text-primary-500">
                                                                                                <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" stroke="currentColor" class="h-5 w-5" fill="none" viewBox="0 0 24 24">
                                                                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
                                                                                                </svg>
                                                                                        </button>
                                                                                    </div>
                                                                                    <button
                                                                                            type="button"
                                                                                            @click="modifyParagraphMultipleBlock(index, widgetIndex)"
                                                                                            class="text-gray-400 hover:text-green-500 ml-auto">
                                                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                                                            viewBox="0 0 24 24"
                                                                                            stroke="currentColor">
                                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                                                        </svg>
                                                                                    </button>

                                                                                    <button
                                                                                            type="button"
                                                                                            @click="showDeleteModalMultiple = true; removeBlockMultipleIndex = index; removeBlockMultipleTemplateIndex = widgetIndex;"
                                                                                            class="text-gray-400 hover:text-red-500">
                                                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                                                            viewBox="0 0 24 24"
                                                                                            stroke="currentColor">
                                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                        </svg>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </template>


                                                                {# Dynamic Field #}
                                                                {% include '@vactory_admin/components/button/button.twig' with {
                                                                    text: 'Add template'|t,
                                                                    size: 'md',
                                                                    type: 'button',
                                                                    variant: 'primary',
                                                                    click_handler: 'showBlocksModal = true; showTemplatesList = true; currentParagraphMultipleItem = index; isParagraphMultiple = true;',
                                                                    icon_left: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-3.5 w-3.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>'
                                                                } %}
                                                            {# END - multiple #}
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="flex justify-end items-center mt-6">
                                                {% include '@vactory_admin/components/button/button.twig' with {
                                                    'variant': 'primary',
                                                    'type': 'button',
                                                    'size': 'md',
                                                    'text': 'Add Item'|t,
                                                    'icon_left': '<svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
                                                    'attributes': create_attribute().setAttribute('@click', 'addParagraphMultipleItem()')
                                                } %}
                                            </div>
                                        </div>
                                    </div>
                        </div>

                        {# Configuration Section #}
                        {% include "@vactory_dashboard/_components/paragraph/appearance.html.twig" with {
                            isParagraphMultiple: true,
                            paragraph: 'paragraphMultipleForm',
                        } %}
                    </div>
                </form>
            </div>
        </div>

        {# Warning Message #}
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
            <div class="flex items-start">
                <svg class="h-5 w-5 text-yellow-500 mt-0.5 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <div>
                    <h4 class="text-sm font-medium text-yellow-800">{{ 'Advanced Configuration Notice'|t }}</h4>
                    <p class="mt-1 text-sm text-yellow-700">{{ 'The advanced view configuration (fields, settings, etc.) must be configured in advanced mode. This form only handles basic content and appearance settings.'|t }}</p>
                </div>
            </div>
        </div>
    </div>
</div> 