{% extends "@vactory_dashboard/_layout/main-content-layout.html.twig" %}

{% block content %}
    <div
        class="h-full flex flex-col" x-data="taxonomyEditor({
             vid: '{{ vid }}',
             vocabulary_label: '{{ vocabulary_label }}',
             language: '{{ language }}',
             fields: '{{ fields|json_encode|e('js') }}'
           })">
    {# Header with back button, title and actions #}
    <div class="bg-white py-4 px-4 border-b border-gray-200 flex justify-between items-center">
        <div class="flex items-center">
            <a href="{{ path('vactory_dashboard.taxonomies', {'vid': vid}) }}"
               class="mr-3 text-gray-500 hover:text-primary-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
                </svg>
            </a>
            <h1 class="text-xl font-medium">{{ "Add"|t }}
                {{ vocabulary_label }}</h1>
        </div>
        <div
                class="flex items-center space-x-4">
            {# Publish checkbox #}
            <div class="flex items-center">
                <input type="checkbox" id="publish-status" x-model="formData.status"
                       class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                <label for="publish-status" class="ml-2 block text-sm text-gray-700">
                    {{ 'Publish'|t }}
                </label>
            </div>

            {% include "@vactory_dashboard/node/_components/langs.html.twig" %}
            <button
                    @click="saveTerm()" :disabled="isSaving" :class="{
                            'opacity-50 cursor-not-allowed': isSaving,
                            'bg-primary-500 hover:bg-primary-600': !isSaving,
                            'bg-primary-400': isSaving
                        }"
                    class="inline-flex items-center justify-center gap-x-2 rounded-md transition-colors px-4 py-2 text-sm text-white bg-primary-500 hover:bg-primary-600">
                <!-- Loading spinner (shown when saving) -->
                <svg x-show="isSaving" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewbox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>

                <!-- Button text (changes based on loading state) -->
                <span x-text="isSaving ? '{{ 'Saving...'|t }}' : '{{ 'Save'|t }}'"></span>
            </button>

        </div>
    </div>

    {# Notification #}
    {% include "@vactory_dashboard/node/_components/message-notification.html.twig" %}

    {# Form Fields #}
    <div class="flex-1 overflow-y-auto">
        <div class="mx-auto">
            <form id="taxonomy-form" @submit.prevent="saveTerm()" class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex gap-y-6 flex-col">
                    <template x-for="(field, fieldName) in fields" :key="field.name">
                        {% include "@vactory_dashboard/_components/fields/form-field-builder.html.twig" with {
                            field: 'field',
                            formData: 'formData',
                            isEdit: false,
                            language: language,
                            node_default_lang: vocabulary_default_lang
                        } %}
                    </template>
                </div>
            </form>
        </div>
    </div>
    {% include "@vactory_dashboard/_components/media/media-library.html.twig" %}
</div> 
{% endblock %}

{% block javascripts %}
    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('taxonomyEditor', (config) => ({
          vid: config.vid,
          vocabulary_label: config.vocabulary_label,
          language: config.language,
          fields: config.fields ? JSON.parse(config.fields) : {},
          formData: {
            fields: {},
            status: true,
          },
          isSaving: false,
          notification: {
            show: false,
            type: 'success',
            message: '',
            timeout: null,
          },

          init() {
            // Initialize form data based on fields
            Object.keys(this.fields).forEach((fieldKey) => {
              const field = this.fields[fieldKey];

              if (field?.textFormatField) {
                setTimeout(() => {
                  const label = document.getElementById(`edit-${field.name.replaceAll('_', '-')}-format-help`);
                  label.style.display = 'none';
                  Drupal.editors.ckeditor5.onChange(document.getElementById(`edit-${field.name.replaceAll('_', '-')}-value`), () => {
                    const ckInstance = Drupal.CKEditor5Instances.values().next().value;
                    this.formData.fields[field.name] = ckInstance.getData();
                  });
                }, '2000');
              }

              // Checkboxes
              if (field.type === 'checkboxes') {
                this.formData.fields[fieldKey] = [];
                return;
              }

              // Radios
              if (field.type === 'radios') {
                this.formData.fields[fieldKey] = '';
                return;
              }

              // Image, file, remote_video, private_file
              if (field.type === 'image' || field.type === 'file' || field.type === 'remote_video' || field.type === 'private_file') {
                this.formData.fields[fieldKey] = {
                  id: null,
                  url: null,
                  name: null,
                  path: fieldKey,
                  key: new Date().getTime(),
                };
              } else {
                this.formData.fields[fieldKey] = '';
              }
            });
          },

          validateForm() {
            const form = document.getElementById('taxonomy-form');
            const requiredInputs = form.querySelectorAll('[required]');
            let isValid = true;
            requiredInputs.forEach(input => {
              if (!input.value) {
                input.classList.add('border-red-500');
                isValid = false;
              }
            });
            return isValid;
          },

          async saveTerm() {
            if (this.isSaving) {
              return;
            }
            this.isSaving = true;

            try {
              const response = await fetch(`/api/vactory-dashboard/taxonomies/${this.vid}/save`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  vid: this.vid,
                  language: this.language,
                  fields: this.formData.fields,
                  status: this.formData.status,
                }),
              });

              const data = await response.json();

              if (!response.ok) {
                throw new Error(data.message || '{{ 'Failed to save term'|t }}');
              }

              this.showNotification('success', '{{ 'Term created successfully'|t }}');

              // Redirect to taxonomy list
              window.location.href = `/admin/dashboard/taxonomy/${this.vid}`;
            } catch (error) {
              console.error('Error saving term:', error);
              this.showNotification('error', error.message);
            } finally {
              this.isSaving = false;
            }
          },

          showNotification(type, message) {
            // Clear any existing timeout
            if (this.notification.timeout) {
              clearTimeout(this.notification.timeout);
            }

            // Show new notification
            this.notification.type = type;
            this.notification.message = message;
            this.notification.show = true;

            // Auto hide after 5 seconds
            this.notification.timeout = setTimeout(() => {
              this.notification.show = false;
            }, 5000);
          },
        }));
      });
    </script>
{% endblock %} 